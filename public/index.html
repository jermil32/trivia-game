<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Social Studies Trivia Game</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #5B0013 0%, #7A0019 100%);
      min-height: 100vh;
      color: #fff;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      color: #FFCC33;
      text-shadow: 0 0 20px rgba(255, 204, 51, 0.5);
    }

    /* Screens */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* Home Screen */
    #home-screen {
      max-width: 500px;
      margin: 0 auto;
      text-align: center;
    }

    .home-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 50px;
    }

    .btn {
      padding: 20px 40px;
      font-size: 1.3rem;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FFCC33 0%, #D4AA00 100%);
      color: #7A0019;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #7A0019 0%, #5B0013 100%);
      color: #FFCC33;
      border: 2px solid #FFCC33;
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* Input styles */
    .input-group {
      margin: 30px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #aaa;
    }

    .input-group input {
      width: 100%;
      padding: 18px;
      font-size: 1.5rem;
      border: 3px solid #5B0013;
      border-radius: 12px;
      background: #3D000D;
      color: #fff;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 5px;
    }

    .input-group input:focus {
      outline: none;
      border-color: #FFCC33;
      box-shadow: 0 0 20px rgba(255, 204, 51, 0.3);
    }

    .input-group input::placeholder {
      text-transform: none;
      letter-spacing: normal;
    }

    /* Lobby Screen */

    .lobby-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      height: calc(100vh - 200px);
    }

    .lobby-main {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 30px;
    }

    .game-code-display {
      text-align: center;
      padding: 20px;
      background: rgba(255, 204, 51, 0.1);
      border-radius: 15px;
      margin-bottom: 30px;
    }

    .game-code-display h2 {
      color: #aaa;
      font-size: 1rem;
      margin-bottom: 10px;
    }

    .game-code-display .code {
      font-size: 3rem;
      font-weight: bold;
      color: #FFCC33;
      letter-spacing: 8px;
    }

    .players-section h3 {
      margin-bottom: 20px;
      color: #FFCC33;
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .player-card {
      background: linear-gradient(135deg, #4D0011 0%, #3D000D 100%);
      padding: 15px 25px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .player-card.host {
      border: 2px solid #ffd700;
    }

    .player-card .crown {
      color: #ffd700;
    }

    .host-controls {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid #5B0013;
    }

    .grade-selection {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .grade-btn {
      flex: 1;
      min-width: 120px;
      padding: 20px;
      font-size: 1.2rem;
      border: 3px solid #5B0013;
      border-radius: 12px;
      background: #3D000D;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .grade-btn:hover {
      border-color: #FFCC33;
    }

    .grade-btn.selected {
      border-color: #FFCC33;
      background: rgba(255, 204, 51, 0.2);
    }

    /* Chat Box */
    .chat-box {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid #5B0013;
      font-weight: bold;
      color: #FFCC33;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-message {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px 15px;
      border-radius: 10px;
    }

    .chat-message .sender {
      font-weight: bold;
      color: #FFCC33;
      margin-bottom: 5px;
    }

    .chat-input-area {
      padding: 15px;
      border-top: 1px solid #5B0013;
      display: flex;
      gap: 10px;
    }

    .chat-input-area input {
      flex: 1;
      padding: 12px;
      border: 2px solid #5B0013;
      border-radius: 8px;
      background: #3D000D;
      color: #fff;
      font-size: 1rem;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: #FFCC33;
    }

    .chat-input-area button {
      padding: 12px 20px;
      background: #FFCC33;
      border: none;
      border-radius: 8px;
      color: #7A0019;
      font-weight: bold;
      cursor: pointer;
    }

    /* Game Screen */

    .game-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      height: calc(100vh - 150px);
    }

    .game-main {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .timer {
      font-size: 3rem;
      font-weight: bold;
      color: #FFCC33;
      background: rgba(255, 204, 51, 0.1);
      padding: 10px 30px;
      border-radius: 15px;
    }

    .timer.warning {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.2);
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .strand-badge {
      background: linear-gradient(135deg, #FFCC33 0%, #D4AA00 100%);
      color: #7A0019;
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    .question-number {
      color: #aaa;
    }

    .question-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .question-text {
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 40px;
      line-height: 1.5;
    }

    .answers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .answer-btn {
      padding: 25px;
      font-size: 1.2rem;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: bold;
      color: #fff;
      text-align: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .answer-btn:nth-child(1) { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
    .answer-btn:nth-child(2) { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
    .answer-btn:nth-child(3) { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); }
    .answer-btn:nth-child(4) { background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); }

    .answer-btn:hover:not(.disabled) {
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .answer-btn:active:not(.disabled) {
      transform: scale(0.98);
    }

    .answer-btn.disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .answer-btn.correct {
      box-shadow: 0 0 30px rgba(46, 204, 113, 0.8);
      animation: correctPulse 0.5s;
    }

    .answer-btn.incorrect {
      opacity: 0.3;
    }

    @keyframes correctPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Scoreboard */
    .scoreboard {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
    }

    .scoreboard-header {
      padding: 20px;
      border-bottom: 1px solid #5B0013;
      font-weight: bold;
      color: #FFCC33;
      text-align: center;
    }

    .scoreboard-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .score-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .score-item.leader {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.1) 100%);
      border: 1px solid rgba(255, 215, 0, 0.3);
    }

    .score-item .name {
      font-weight: bold;
    }

    .score-item .score {
      font-size: 1.5rem;
      font-weight: bold;
      color: #FFCC33;
    }

    /* Result overlay */
    .result-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .result-overlay.active {
      display: flex;
    }

    .result-content {
      background: linear-gradient(135deg, #5B0013 0%, #7A0019 100%);
      padding: 50px;
      border-radius: 30px;
      text-align: center;
      max-width: 500px;
      border: 3px solid #FFCC33;
    }

    .result-content h2 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #FFCC33;
    }

    .result-content .winner-name {
      font-size: 2rem;
      color: #FFCC33;
      margin-bottom: 30px;
    }

    .result-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 204, 51, 0.95);
      color: #7A0019;
      padding: 15px 30px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 1001;
      display: none;
    }

    .notification.error {
      background: rgba(180, 0, 30, 0.95);
      color: #fff;
    }

    .notification.active {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Round winner announcement */
    .round-winner {
      text-align: center;
      padding: 20px;
      margin-top: 20px;
      background: rgba(255, 204, 51, 0.2);
      border-radius: 15px;
      display: none;
    }

    .round-winner.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .round-winner h3 {
      color: #FFCC33;
      font-size: 1.5rem;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .lobby-layout, .game-layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      .chat-box, .scoreboard {
        height: 300px;
      }

      .question-text {
        font-size: 1.3rem;
      }

      .answers-grid {
        grid-template-columns: 1fr;
      }

      .answer-btn {
        padding: 20px;
        font-size: 1rem;
      }
    }

    /* Name entry modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #5B0013 0%, #7A0019 100%);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      border: 2px solid #FFCC33;
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: #FFCC33;
    }

    .modal-content input {
      width: 100%;
      padding: 15px;
      font-size: 1.2rem;
      border: 2px solid #5B0013;
      border-radius: 10px;
      background: #3D000D;
      color: #fff;
      text-align: center;
      margin-bottom: 20px;
    }

    .modal-content input:focus {
      outline: none;
      border-color: #FFCC33;
    }

    /* Leave button */
    .leave-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(255, 204, 51, 0.2);
      border: 2px solid #FFCC33;
      border-radius: 10px;
      color: #FFCC33;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .leave-btn:hover {
      background: rgba(255, 204, 51, 0.4);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Social Studies Trivia</h1>

    <!-- Home Screen -->
    <div id="home-screen" class="screen active">
      <div class="home-buttons">
        <div class="input-group">
          <label>Enter 8-character game code:</label>
          <input type="text" id="game-code-input" maxlength="8" placeholder="e.g., ABCD1234">
        </div>
        <button class="btn btn-primary" id="create-game-btn">Create Game</button>
        <button class="btn btn-secondary" id="join-game-btn">Join Game</button>
      </div>
    </div>

    <!-- Name Entry Modal -->
    <div id="name-modal" class="modal">
      <div class="modal-content">
        <h2>Enter Your Name</h2>
        <input type="text" id="player-name-input" maxlength="20" placeholder="Your name">
        <button class="btn btn-primary" id="submit-name-btn">Join Game</button>
      </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen" class="screen">
      <button class="leave-btn" id="leave-lobby-btn">Leave Game</button>
      <div class="lobby-layout">
        <div class="lobby-main">
          <div class="game-code-display">
            <h2>Game Code</h2>
            <div class="code" id="display-game-code">--------</div>
          </div>

          <div class="players-section">
            <h3>Players (<span id="player-count">0</span>)</h3>
            <div class="players-list" id="players-list"></div>
          </div>

          <div class="host-controls" id="host-controls" style="display: none;">
            <h3>Select Grade Level</h3>
            <div class="grade-selection">
              <button class="grade-btn" data-grade="6th">6th Grade</button>
              <button class="grade-btn" data-grade="7th">7th Grade</button>
              <button class="grade-btn" data-grade="8th">8th Grade</button>
            </div>
            <button class="btn btn-primary" id="start-game-btn" disabled>Start Game</button>
          </div>

          <div id="waiting-message" style="display: none; text-align: center; margin-top: 30px; color: #aaa;">
            <p>Waiting for the host to start the game...</p>
          </div>
        </div>

        <div class="chat-box">
          <div class="chat-header">Chat</div>
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message..." maxlength="200">
            <button id="send-chat-btn">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
      <button class="leave-btn" id="leave-game-btn">Leave Game</button>
      <div class="game-layout">
        <div class="game-main">
          <div class="game-header">
            <span class="question-number">Question #<span id="question-num">1</span></span>
            <div class="timer" id="timer">15</div>
            <span class="strand-badge" id="strand-badge">History</span>
          </div>

          <div class="question-area">
            <div class="question-text" id="question-text">Loading question...</div>
            <div class="answers-grid" id="answers-grid">
              <button class="answer-btn" data-index="0">Answer 1</button>
              <button class="answer-btn" data-index="1">Answer 2</button>
              <button class="answer-btn" data-index="2">Answer 3</button>
              <button class="answer-btn" data-index="3">Answer 4</button>
            </div>
            <div class="round-winner" id="round-winner">
              <h3><span id="round-winner-name"></span> got it right!</h3>
            </div>
          </div>
        </div>

        <div class="scoreboard">
          <div class="scoreboard-header">Scoreboard (First to 10)</div>
          <div class="scoreboard-list" id="scoreboard-list"></div>
          <div class="chat-box" style="border-radius: 0 0 20px 20px; flex: 1;">
            <div class="chat-header">Chat</div>
            <div class="chat-messages" id="game-chat-messages"></div>
            <div class="chat-input-area">
              <input type="text" id="game-chat-input" placeholder="Type a message..." maxlength="200">
              <button id="game-send-chat-btn">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Result Overlay -->
  <div id="result-overlay" class="result-overlay">
    <div class="result-content">
      <h2>Game Over!</h2>
      <div class="winner-name" id="game-winner-name">Player wins!</div>
      <div class="result-buttons">
        <button class="btn btn-primary" id="play-again-btn">Play Again</button>
        <button class="btn btn-secondary" id="exit-game-btn">Leave Game</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // State
    let isHost = false;
    let selectedGrade = null;
    let gameCode = null;
    let myName = null;

    // Elements
    const screens = {
      home: document.getElementById('home-screen'),
      lobby: document.getElementById('lobby-screen'),
      game: document.getElementById('game-screen')
    };

    const elements = {
      gameCodeInput: document.getElementById('game-code-input'),
      createGameBtn: document.getElementById('create-game-btn'),
      joinGameBtn: document.getElementById('join-game-btn'),
      nameModal: document.getElementById('name-modal'),
      playerNameInput: document.getElementById('player-name-input'),
      submitNameBtn: document.getElementById('submit-name-btn'),
      displayGameCode: document.getElementById('display-game-code'),
      playerCount: document.getElementById('player-count'),
      playersList: document.getElementById('players-list'),
      hostControls: document.getElementById('host-controls'),
      waitingMessage: document.getElementById('waiting-message'),
      gradeBtns: document.querySelectorAll('.grade-btn'),
      startGameBtn: document.getElementById('start-game-btn'),
      chatMessages: document.getElementById('chat-messages'),
      chatInput: document.getElementById('chat-input'),
      sendChatBtn: document.getElementById('send-chat-btn'),
      gameChatMessages: document.getElementById('game-chat-messages'),
      gameChatInput: document.getElementById('game-chat-input'),
      gameSendChatBtn: document.getElementById('game-send-chat-btn'),
      timer: document.getElementById('timer'),
      questionNum: document.getElementById('question-num'),
      strandBadge: document.getElementById('strand-badge'),
      questionText: document.getElementById('question-text'),
      answersGrid: document.getElementById('answers-grid'),
      answerBtns: document.querySelectorAll('.answer-btn'),
      scoreboardList: document.getElementById('scoreboard-list'),
      roundWinner: document.getElementById('round-winner'),
      roundWinnerName: document.getElementById('round-winner-name'),
      resultOverlay: document.getElementById('result-overlay'),
      gameWinnerName: document.getElementById('game-winner-name'),
      playAgainBtn: document.getElementById('play-again-btn'),
      exitGameBtn: document.getElementById('exit-game-btn'),
      leaveLobbyBtn: document.getElementById('leave-lobby-btn'),
      leaveGameBtn: document.getElementById('leave-game-btn'),
      notification: document.getElementById('notification')
    };

    // Helper functions
    function showScreen(screenName) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[screenName].classList.add('active');
    }

    function showNotification(message, isError = false) {
      elements.notification.textContent = message;
      elements.notification.className = 'notification active' + (isError ? ' error' : '');
      setTimeout(() => {
        elements.notification.classList.remove('active');
      }, 3000);
    }

    function updatePlayersList(players) {
      elements.playersList.innerHTML = '';
      elements.playerCount.textContent = players.length;

      players.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card' + (player.isHost ? ' host' : '');
        card.innerHTML = `
          ${player.isHost ? '<span class="crown">&#128081;</span>' : ''}
          <span>${player.name}</span>
        `;
        elements.playersList.appendChild(card);
      });
    }

    function updateScoreboard(players) {
      const sorted = [...players].sort((a, b) => b.score - a.score);
      elements.scoreboardList.innerHTML = '';

      sorted.forEach((player, index) => {
        const item = document.createElement('div');
        item.className = 'score-item' + (index === 0 && player.score > 0 ? ' leader' : '');
        item.innerHTML = `
          <span class="name">${player.name}</span>
          <span class="score">${player.score}/10</span>
        `;
        elements.scoreboardList.appendChild(item);
      });
    }

    function addChatMessage(playerName, message) {
      const msgEl = document.createElement('div');
      msgEl.className = 'chat-message';
      msgEl.innerHTML = `
        <div class="sender">${playerName}</div>
        <div class="text">${message}</div>
      `;

      elements.chatMessages.appendChild(msgEl);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;

      elements.gameChatMessages.appendChild(msgEl.cloneNode(true));
      elements.gameChatMessages.scrollTop = elements.gameChatMessages.scrollHeight;
    }

    function disableAnswers() {
      elements.answerBtns.forEach(btn => btn.classList.add('disabled'));
    }

    function enableAnswers() {
      elements.answerBtns.forEach(btn => {
        btn.classList.remove('disabled', 'correct', 'incorrect');
      });
    }

    function showCorrectAnswer(correctIndex) {
      elements.answerBtns.forEach((btn, idx) => {
        if (idx === correctIndex) {
          btn.classList.add('correct');
        } else {
          btn.classList.add('incorrect');
        }
      });
    }

    // Event Listeners
    elements.createGameBtn.addEventListener('click', () => {
      const code = elements.gameCodeInput.value.trim();
      if (code.length !== 8) {
        showNotification('Game code must be exactly 8 characters', true);
        return;
      }
      if (!/^[A-Za-z0-9]+$/.test(code)) {
        showNotification('Game code must contain only letters and numbers', true);
        return;
      }
      socket.emit('createGame', code);
    });

    elements.joinGameBtn.addEventListener('click', () => {
      const code = elements.gameCodeInput.value.trim();
      if (code.length !== 8) {
        showNotification('Game code must be exactly 8 characters', true);
        return;
      }
      socket.emit('joinGame', code);
    });

    elements.submitNameBtn.addEventListener('click', () => {
      const name = elements.playerNameInput.value.trim();
      if (!name) {
        showNotification('Please enter your name', true);
        return;
      }
      myName = name;
      socket.emit('setName', name);
      elements.nameModal.classList.remove('active');
    });

    elements.playerNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        elements.submitNameBtn.click();
      }
    });

    elements.gradeBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        elements.gradeBtns.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedGrade = btn.dataset.grade;
        elements.startGameBtn.disabled = false;
      });
    });

    elements.startGameBtn.addEventListener('click', () => {
      if (!selectedGrade) return;
      socket.emit('startGame', selectedGrade);
    });

    // Chat
    function sendChat(input) {
      const message = input.value.trim();
      if (!message) return;
      socket.emit('chatMessage', message);
      input.value = '';
    }

    elements.sendChatBtn.addEventListener('click', () => sendChat(elements.chatInput));
    elements.chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat(elements.chatInput);
    });

    elements.gameSendChatBtn.addEventListener('click', () => sendChat(elements.gameChatInput));
    elements.gameChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat(elements.gameChatInput);
    });

    // Answer buttons
    elements.answerBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        if (btn.classList.contains('disabled')) return;
        const index = parseInt(btn.dataset.index);
        socket.emit('submitAnswer', index);
        disableAnswers();
      });
    });

    // Leave/Exit buttons
    elements.leaveLobbyBtn.addEventListener('click', () => {
      socket.emit('leaveGame');
      location.reload();
    });

    elements.leaveGameBtn.addEventListener('click', () => {
      socket.emit('leaveGame');
      location.reload();
    });

    elements.exitGameBtn.addEventListener('click', () => {
      socket.emit('leaveGame');
      location.reload();
    });

    elements.playAgainBtn.addEventListener('click', () => {
      socket.emit('playAgain');
    });

    // Socket events
    socket.on('gameCreated', (data) => {
      isHost = true;
      gameCode = data.code;
      elements.displayGameCode.textContent = data.code;
      elements.hostControls.style.display = 'block';
      elements.waitingMessage.style.display = 'none';
      elements.nameModal.classList.add('active');
      showScreen('lobby');
    });

    socket.on('gameJoined', (data) => {
      isHost = false;
      gameCode = data.code;
      elements.displayGameCode.textContent = data.code;
      elements.hostControls.style.display = 'none';
      elements.waitingMessage.style.display = 'block';
      elements.nameModal.classList.add('active');
      showScreen('lobby');
    });

    socket.on('playerList', (players) => {
      updatePlayersList(players);
      updateScoreboard(players);
    });

    socket.on('chatMessage', (data) => {
      addChatMessage(data.playerName, data.message);
    });

    socket.on('gameStarted', (data) => {
      showScreen('game');
      showNotification(`Game started! Grade level: ${data.gradeLevel}`);
    });

    socket.on('newQuestion', (data) => {
      elements.roundWinner.classList.remove('active');
      enableAnswers();
      elements.questionNum.textContent = data.questionNumber;
      elements.strandBadge.textContent = data.strand.charAt(0).toUpperCase() + data.strand.slice(1);
      elements.questionText.textContent = data.question;

      data.answers.forEach((answer, idx) => {
        elements.answerBtns[idx].textContent = answer;
      });

      elements.timer.textContent = '15';
      elements.timer.classList.remove('warning');
    });

    socket.on('timerUpdate', (time) => {
      elements.timer.textContent = time;
      if (time <= 2) {
        elements.timer.classList.add('warning');
      }
    });

    socket.on('questionResult', (data) => {
      disableAnswers();
      showCorrectAnswer(data.correctIndex);
      elements.roundWinnerName.textContent = data.winnerName;
      elements.roundWinner.classList.add('active');
      updateScoreboard(data.scores);
    });

    socket.on('timeUp', (data) => {
      disableAnswers();
      showCorrectAnswer(data.correctIndex);
      elements.roundWinner.classList.remove('active');
      showNotification("Time's up! No one answered correctly.");
      updateScoreboard(data.scores);
    });

    socket.on('gameOver', (data) => {
      elements.gameWinnerName.textContent = `${data.winner.name} wins with ${data.winner.score} points!`;
      elements.resultOverlay.classList.add('active');
      updateScoreboard(data.scores);

      // Only show play again button to host
      elements.playAgainBtn.style.display = isHost ? 'inline-block' : 'none';
    });

    socket.on('gameReset', (players) => {
      elements.resultOverlay.classList.remove('active');
      showScreen('lobby');
      updatePlayersList(players);
      updateScoreboard(players);
      selectedGrade = null;
      elements.gradeBtns.forEach(b => b.classList.remove('selected'));
      elements.startGameBtn.disabled = true;
      showNotification('Game reset! Ready for another round.');
    });

    socket.on('hostLeft', () => {
      showNotification('The host has left the game', true);
      setTimeout(() => {
        location.reload();
      }, 2000);
    });

    socket.on('error', (message) => {
      showNotification(message, true);
    });
  </script>
</body>
</html>
